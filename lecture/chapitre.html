<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture - Hexart</title>
    <link rel="stylesheet" href="../assets/css/general.css">
    <link rel="stylesheet" href="../assets/css/universal.css">
    <style>
        .reader-container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .page-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 1rem 0;
            gap: 1rem;
        }
        
        .chapter-navigation {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .page-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            cursor: zoom-in;
            transition: transform 0.3s;
            display: block;
            margin: 0 auto;
        }
        
        .page-image:hover {
            transform: scale(1.01);
        }
        
        .page-info {
            text-align: center;
            margin: 1rem 0;
            color: #666;
        }
        
        .modal-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1rem;
        }
        
        .chapter-selector {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* SUPPRESSION DES BOUTONS FLOTTANTS */
        .quick-nav {
            display: none !important;
        }

        /* Am√©lioration de l'apparence */
        .reader-controls {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .page-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 2rem 0;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #7f8c8d;
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none !important;
        }

        .text-center {
            text-align: center;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .p-3 { padding: 1rem; }
        .p-4 { padding: 1.5rem; }
        .mb-3 { margin-bottom: 1rem; }

        /* Styles pour les commentaires */
        .comment {
            background: white;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 4px solid #27ae60;
        }

        .comment.pending {
            border-left-color: #f39c12;
            background: #fffbf0;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .comment-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .btn-approve {
            background: #27ae60;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .auth-status {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #3498db;
        }
    </style>
</head>
<body>
    <header class="compact-header">
        <div class="container header-content">
            <a href="../index.html" class="logo">HEXART</a>
        </div>
    </header>

    <!-- Menu universel -->
    <nav class="main-nav">
        <div class="nav-container">
            <a href="../index.html" class="nav-link">üè† Accueil</a>
            <a href="../galerie/bd.html?bd=Fantaryou" class="nav-link">üìö BD Fantaryou</a>
            <a href="../connexion.html" class="nav-link">üîê Connexion</a>
            <a href="../admin/index.html" class="nav-link">‚öôÔ∏è Admin</a>
        </div>
    </nav>

    <main class="container reader-container">
        <!-- S√©lecteur de chapitre -->
        <div class="chapter-selector">
            <label for="chapterSelect"><strong>üìñ Navigation rapide :</strong></label>
            <select id="chapterSelect" class="form-input" style="margin-left: 1rem; width: auto;">
                <option value="">Choisir un chapitre...</option>
                <option value="chapitre-1">Chapitre 1 - Le Commencement</option>
                <option value="chapitre-2">Chapitre 2 - La For√™t Myst√©rieuse</option>
                <option value="chapitre-3">Chapitre 3 - La Rencontre</option>
                <option value="chapitre-4">Chapitre 4 - Le Temple Ancien</option>
                <option value="chapitre-5">Chapitre 5 - La Cit√© Cach√©e</option>
                <option value="chapitre-6">Chapitre 6 - L'Oc√©an des √Çmes</option>
                <option value="chapitre-7">Chapitre 7 - Le D√©sert des Illusions</option>
                <option value="chapitre-8">Chapitre 8 - La Forteresse des Ombres</option>
                <option value="chapitre-9">Chapitre 9 - Le Jardin des Dragons</option>
                <option value="chapitre-10">Chapitre 10 - Le Labyrinthe du Temps</option>
                <option value="chapitre-11">Chapitre 11 - Le Tr√¥ne de Cristal</option>
                <option value="chapitre-12">Chapitre 12 - L'Aube Nouvelle</option>
            </select>
            <a href="../galerie/bd.html" class="btn btn-secondary" style="margin-left: 1rem;">
                ‚Üê Retour aux chapitres
            </a>
        </div>

        <!-- Navigation principale -->
        <div class="reader-controls">
            <div class="chapter-navigation">
                <button id="prevChapter" class="btn btn-secondary" disabled>
                    ‚Üê Chapitre pr√©c√©dent
                </button>
                
                <div class="text-center" style="min-width: 300px;">
                    <h2 id="chapterTitle">Chargement...</h2>
                    <div id="pageCounter" class="page-info">Page 1/1</div>
                </div>
                
                <button id="nextChapter" class="btn btn-secondary">
                    Chapitre suivant ‚Üí
                </button>
            </div>
            
            <button class="btn btn-primary" onclick="openFullscreen()" title="Plein √©cran">
                ‚õ∂ Plein √©cran
            </button>
        </div>

        <!-- Image de la page CENTR√âE -->
        <div class="text-center">
            <img id="pageImage" class="page-image" src="" alt="Page de BD" onclick="openFullscreen()">
        </div>

        <!-- Navigation pages -->
        <div class="page-controls">
            <button id="prevPage" class="btn btn-primary" disabled>‚Üê Page pr√©c√©dente</button>
            
            <div class="text-center">
                <div id="currentPage" class="stat-number">1</div>
                <div style="font-size: 0.9rem; color: #666;">Page actuelle</div>
            </div>
            
            <button id="nextPage" class="btn btn-primary">Page suivante ‚Üí</button>
        </div>

        <!-- Section commentaires -->
        <section class="comments-section">
            <h3 class="text-center mb-3">üí¨ Commentaires</h3>
            
            <!-- Statut authentification -->
            <div id="authStatus" class="auth-status mb-3"></div>
            
            <!-- Formulaire de commentaire -->
            <div id="commentFormContainer" class="card p-3 mb-3">
                <h4>üìù Laisser un commentaire</h4>
                <form id="commentForm">
                    <div class="form-group">
                        <textarea 
                            id="commentText" 
                            class="form-textarea" 
                            placeholder="Partagez vos impressions sur cette page..."
                            rows="4"
                        ></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Publier le commentaire</button>
                </form>
            </div>
            
            <!-- Liste des commentaires -->
            <div id="commentsList">
                <div class="text-center p-4">
                    <p>Chargement des commentaires...</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal Plein √âcran -->
    <div class="modal" id="imageModal">
        <span class="close-btn" id="closeModal">&times;</span>
        <span class="prev-btn" id="prevImageModal">&#10094;</span>
        <span class="next-btn" id="nextImageModal">&#10095;</span>
        <img class="modal-content" id="modalImage">
        <div class="modal-controls">
            <button class="btn btn-secondary btn-small" onclick="exitFullscreen()">Quitter le plein √©cran</button>
        </div>
    </div>

    <footer style="background: #2c3e50; color: white; text-align: center; padding: 2rem; margin-top: 3rem;">
        <div class="container">
            <p>¬© 2024 Hexart - Utilisez les fl√®ches ‚Üê ‚Üí pour naviguer ‚Ä¢ ESC pour quitter le plein √©cran</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script>
        // ===== SYST√àME DE COMMENTAIRES AM√âLIOR√â =====
        const API_URL = '/api/comments.php';

        class CommentSystem {
            constructor() {
                this.currentBD = '';
                this.currentChapitre = '';
            }

            async loadComments(bdName, chapitreId) {
                this.currentBD = bdName;
                this.currentChapitre = chapitreId;
                
                try {
                    const response = await fetch(`${API_URL}?bd=${bdName}&chapitre=${chapitreId}`);
                    if (!response.ok) throw new Error('Erreur r√©seau');
                    
                    const comments = await response.json();
                    this.displayComments(comments);
                    this.updateAuthStatus();
                } catch (error) {
                    console.error('Erreur chargement commentaires:', error);
                    this.displayComments([]);
                    this.showMessage('Impossible de charger les commentaires', 'error');
                }
            }

            async addComment(contenu) {
                if (!contenu.trim()) {
                    this.showMessage('Veuillez √©crire un commentaire', 'error');
                    return;
                }

                const currentUser = this.getCurrentUser();
                
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            auteur: currentUser.username,
                            contenu: contenu.trim(),
                            bdName: this.currentBD,
                            chapitreId: this.currentChapitre
                        })
                    });

                    if (response.ok) {
                        document.getElementById('commentText').value = '';
                        this.loadComments(this.currentBD, this.currentChapitre);
                        this.showMessage('Commentaire envoy√© ! Il sera visible apr√®s mod√©ration.', 'success');
                    } else {
                        throw new Error('Erreur serveur');
                    }
                } catch (error) {
                    console.error('Erreur envoi commentaire:', error);
                    this.showMessage('Erreur lors de l\'envoi du commentaire', 'error');
                }
            }

            displayComments(comments) {
                const container = document.getElementById('commentsList');
                const currentUser = this.getCurrentUser();
                
                // Les utilisateurs normaux voient seulement les commentaires approuv√©s
                const visibleComments = (currentUser.role === 'admin' || currentUser.role === 'moderateur') 
                    ? comments 
                    : comments.filter(comment => comment.approuve);

                if (visibleComments.length === 0) {
                    container.innerHTML = `
                        <div class="text-center p-4">
                            <p style="color: #666;">üí¨ Soyez le premier √† commenter cette BD !</p>
                        </div>
                    `;
                    return;
                }

                // Trier par date (plus r√©cent en premier)
                visibleComments.sort((a, b) => new Date(b.date) - new Date(a.date));

                container.innerHTML = visibleComments.map(comment => `
                    <div class="comment ${comment.approuve ? '' : 'pending'}">
                        <div class="comment-header">
                            <div>
                                <strong>${comment.auteur}</strong>
                                ${!comment.approuve ? '<span style="background: #f39c12; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.7rem; margin-left: 0.5rem;">‚è≥ En attente</span>' : ''}
                            </div>
                            <span style="color: #666; font-size: 0.9rem;">
                                ${new Date(comment.date).toLocaleDateString('fr-FR')} √† 
                                ${new Date(comment.date).toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'})}
                            </span>
                        </div>
                        <p style="margin: 0; line-height: 1.5;">${comment.contenu}</p>
                        ${!comment.approuve && (currentUser.role === 'admin' || currentUser.role === 'moderateur') ? `
                            <div class="comment-actions">
                                <button onclick="commentSystem.approveComment('${comment.id}')" class="btn-approve">‚úÖ Approuver</button>
                                <button onclick="commentSystem.deleteComment('${comment.id}')" class="btn-delete">üóëÔ∏è Supprimer</button>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            }

            async approveComment(commentId) {
                try {
                    // Dans un vrai syst√®me, vous auriez un endpoint PATCH pour approuver
                    // Pour l'instant on simule avec DELETE + recr√©ation
                    const comments = await this.getCurrentComments();
                    const comment = comments.find(c => c.id === commentId);
                    
                    if (comment) {
                        // Supprimer l'ancien commentaire
                        await fetch(`${API_URL}?id=${commentId}`, { method: 'DELETE' });
                        
                        // Recr√©er comme approuv√©
                        await fetch(API_URL, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                ...comment,
                                approuve: true,
                                id: undefined // Laisser le serveur g√©n√©rer un nouvel ID
                            })
                        });
                        
                        this.loadComments(this.currentBD, this.currentChapitre);
                        this.showMessage('Commentaire approuv√© !', 'success');
                    }
                } catch (error) {
                    console.error('Erreur approbation:', error);
                    this.showMessage('Erreur lors de l\'approbation', 'error');
                }
            }

            async deleteComment(commentId) {
                if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce commentaire ?')) return;
                
                try {
                    await fetch(`${API_URL}?id=${commentId}`, { method: 'DELETE' });
                    this.loadComments(this.currentBD, this.currentChapitre);
                    this.showMessage('Commentaire supprim√© !', 'success');
                } catch (error) {
                    console.error('Erreur suppression:', error);
                    this.showMessage('Erreur lors de la suppression', 'error');
                }
            }

            updateAuthStatus() {
                const authStatus = document.getElementById('authStatus');
                const commentFormContainer = document.getElementById('commentFormContainer');
                const currentUser = this.getCurrentUser();
                
                if (currentUser.username) {
                    authStatus.innerHTML = `
                        <p>üëã Connect√© en tant que <strong>${currentUser.username}</strong>
                        ${currentUser.role === 'admin' || currentUser.role === 'moderateur' ? 
                          ` (<span style="color: #e74c3c;">${currentUser.role}</span>)` : ''}
                        </p>
                    `;
                    
                    commentFormContainer.style.display = 'block';
                } else {
                    authStatus.innerHTML = `
                        <p>
                            <a href="../connexion.html" style="color: #3498db; font-weight: bold;">üîê Connectez-vous</a> 
                            ou <a href="../inscription.html" style="color: #3498db; font-weight: bold;">üìù cr√©ez un compte</a> pour commenter
                        </p>
                    `;
                    commentFormContainer.style.display = 'none';
                }
            }

            getCurrentUser() {
                try {
                    return JSON.parse(localStorage.getItem('currentUser') || '{"username": "", "role": ""}');
                } catch {
                    return { username: "", role: "" };
                }
            }

            async getCurrentComments() {
                try {
                    const response = await fetch(`${API_URL}?bd=${this.currentBD}&chapitre=${this.currentChapitre}`);
                    return await response.json();
                } catch {
                    return [];
                }
            }

            showMessage(message, type) {
                // Cr√©er une notification temporaire
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 1rem 2rem;
                    background: ${type === 'success' ? '#27ae60' : '#e74c3c'};
                    color: white;
                    border-radius: 8px;
                    z-index: 10000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                `;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 4000);
            }
        }

        // Initialiser le syst√®me de commentaires
        const commentSystem = new CommentSystem();

        // Donn√©es compl√®tes des 12 chapitres
        const chapitresData = {
            "chapitre-1": {
                title: "Chapitre 1 : Le Commencement",
                description: "Fantaryou d√©couvre ses pouvoirs",
                episodes: generateEpisodes("Fantaryou-Chapitre-01", "Episode-01", 31, 0)
            },
            "chapitre-2": {
                title: "Chapitre 2 : La For√™t Myst√©rieuse",
                description: "Une exploration p√©rilleuse", 
                episodes: generateEpisodes("Fantaryou-Chapitre-01", "Episode-02", 30, 31)
            },
            "chapitre-3": {
                title: "Chapitre 3 : La Rencontre",
                description: "Une alliance inattendue",
                episodes: generateEpisodes("Fantaryou-Chapitre-01", "Episode-03", 30, 61)
            },
            "chapitre-4": {
                title: "Chapitre 4 : Le Temple Ancien",
                description: "D√©couverte des secrets ancestraux",
                episodes: generateEpisodes("Fantaryou-Chapitre-01", "Episode-04", 32, 91)
            },
            "chapitre-5": {
                title: "Chapitre 5 : La Cit√© Cach√©e",
                description: "Exploration des souterrains",
                episodes: generateEpisodes("Fantaryou-Chapitre-01", "Episode-05", 31, 123)
            },
            "chapitre-6": {
                title: "Chapitre 6 : L'Oc√©an des √Çmes",
                description: "Travers√©e des eaux mystiques",
                episodes: generateEpisodes("Fantaryou-Chapitre-01", "Episode-06", 33, 154)
            },
            "chapitre-7": {
                title: "Chapitre 7 : Le D√©sert des Illusions",
                description: "Survie dans les sables",
                episodes: generateEpisodes("Fantaryou-Chapitre-01", "Episode-07", 33, 187)
            },
            "chapitre-8": {
                title: "Chapitre 8 : La Forteresse des Ombres",
                description: "Infiltration du bastion ennemi",
                episodes: generateEpisodes("Fantaryou-Chapitre-01", "Episode-08", 31, 220)
            },
            "chapitre-9": {
                title: "Chapitre 9 : Le Jardin des Dragons",
                description: "Rencontre avec les gardiens",
                episodes: generateEpisodes("Fantaryou-Chapitre-01", "Episode-09", 32, 251)
            },
            "chapitre-10": {
                title: "Chapitre 10 : Le Labyrinthe du Temps",
                description: "Course contre la montre",
                episodes: generateEpisodes("Fantaryou-Chapitre-01", "Episode-10", 32, 283)
            },
            "chapitre-11": {
                title: "Chapitre 11 : Le Tr√¥ne de Cristal",
                description: "Confrontation finale",
                episodes: generateEpisodes("Fantaryou-Chapitre-01", "Episode-11", 32, 315)
            },
            "chapitre-12": {
                title: "Chapitre 12 : L'Aube Nouvelle",
                description: "Conclusion √©pique",
                episodes: generateEpisodes("Fantaryou-Chapitre-01", "Episode-12", 32, 347)
            }
        };

        function generateEpisodes(chapitre, episode, count, start) {
            const episodes = [];
            for (let i = 0; i < count; i++) {
                episodes.push({
                    id: start + i,
                    page: i + 1,
                    url: `../assets/images/BD/${chapitre}/${episode}/${i}.jpg`
                });
            }
            return episodes;
        }

        const chapitresList = Object.keys(chapitresData);
        let currentBD = 'Fantaryou';
        let currentChapitre = '';
        let currentChapitreIndex = 0;
        let currentChapitreData = null;
        let currentPage = 0;
        let isModalOpen = false;

        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                bd: params.get('bd') || 'Fantaryou',
                chapitre: params.get('chapitre')
            };
        }

        function initializeReader() {
            const { bd, chapitre } = getUrlParams();
            
            currentBD = bd;
            currentChapitre = chapitre;

            if (!chapitre || !chapitresData[chapitre]) {
                // Rediriger vers le premier chapitre si invalide
                navigateToChapitre(0);
                return;
            }

            currentChapitreIndex = chapitresList.indexOf(chapitre);
            currentChapitreData = chapitresData[chapitre];
            currentPage = 0;

            updateDisplay();
            updateChapterSelector();
            
            // Charger les commentaires
            commentSystem.loadComments(currentBD, currentChapitre);
        }

        function updateDisplay() {
            if (!currentChapitreData) return;

            document.getElementById('chapterTitle').textContent = currentChapitreData.title;
            document.getElementById('pageCounter').textContent = `Page ${currentPage + 1}/${currentChapitreData.episodes.length}`;
            document.getElementById('currentPage').textContent = currentPage + 1;
            
            // Mettre √† jour l'image (CENTR√âE)
            const pageImage = document.getElementById('pageImage');
            if (currentChapitreData.episodes[currentPage]) {
                pageImage.src = currentChapitreData.episodes[currentPage].url;
                pageImage.alt = `Page ${currentPage + 1} - ${currentChapitreData.title}`;
                pageImage.style.display = 'block';
            } else {
                pageImage.style.display = 'none';
            }
            
            // Gestion des boutons
            updateNavigationButtons();
        }

        function updateNavigationButtons() {
            document.getElementById('prevPage').disabled = currentPage === 0;
            document.getElementById('nextPage').disabled = currentPage === currentChapitreData.episodes.length - 1;
            document.getElementById('prevChapter').disabled = currentChapitreIndex === 0;
            document.getElementById('nextChapter').disabled = currentChapitreIndex === chapitresList.length - 1;
        }

        function updateChapterSelector() {
            const selector = document.getElementById('chapterSelect');
            selector.value = currentChapitre;
        }

        function navigateToPage(page) {
            if (currentChapitreData && page >= 0 && page < currentChapitreData.episodes.length) {
                currentPage = page;
                updateDisplay();
                updateModalImage();
            }
        }

        function navigateToChapitre(index) {
            if (index >= 0 && index < chapitresList.length) {
                currentChapitreIndex = index;
                currentChapitre = chapitresList[index];
                currentChapitreData = chapitresData[currentChapitre];
                currentPage = 0;
                
                // Mettre √† jour l'URL
                const newUrl = `${window.location.pathname}?bd=${currentBD}&chapitre=${currentChapitre}`;
                window.history.pushState({}, '', newUrl);
                
                updateDisplay();
                updateChapterSelector();
                
                // Recharger les commentaires
                commentSystem.loadComments(currentBD, currentChapitre);
            }
        }

        // Gestion du modal
        function openFullscreen() {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            
            if (currentChapitreData && currentChapitreData.episodes[currentPage]) {
                modalImage.src = currentChapitreData.episodes[currentPage].url;
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                isModalOpen = true;
            }
        }

        function closeFullscreen() {
            document.getElementById('imageModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            isModalOpen = false;
        }

        function exitFullscreen() { closeFullscreen(); }

        function updateModalImage() {
            const modalImage = document.getElementById('modalImage');
            if (currentChapitreData && currentChapitreData.episodes[currentPage]) {
                modalImage.src = currentChapitreData.episodes[currentPage].url;
            }
        }

        // Navigation clavier AM√âLIOR√âE (fonctionne dans le modal)
        function handleKeyboard(e) {
            // Navigation toujours active, m√™me dans le modal
            switch(e.key) {
                case 'ArrowLeft':
                    e.preventDefault();
                    if (currentPage > 0) {
                        navigateToPage(currentPage - 1);
                    } else if (currentChapitreIndex > 0) {
                        navigateToChapitre(currentChapitreIndex - 1);
                    }
                    break;
                    
                case 'ArrowRight':
                    e.preventDefault();
                    if (currentPage < currentChapitreData.episodes.length - 1) {
                        navigateToPage(currentPage + 1);
                    } else if (currentChapitreIndex < chapitresList.length - 1) {
                        navigateToChapitre(currentChapitreIndex + 1);
                    }
                    break;
                    
                case 'Escape':
                    if (isModalOpen) {
                        e.preventDefault();
                        closeFullscreen();
                    }
                    break;
                    
                case 'Home':
                    e.preventDefault();
                    navigateToPage(0);
                    break;
                    
                case 'End':
                    e.preventDefault();
                    navigateToPage(currentChapitreData.episodes.length - 1);
                    break;
                    
                case ' ':
                    e.preventDefault();
                    if (currentPage < currentChapitreData.episodes.length - 1) {
                        navigateToPage(currentPage + 1);
                    }
                    break;
            }
        }

        // √âv√©nements
        document.addEventListener('DOMContentLoaded', function() {
            initializeReader();
            
            // √âv√©nements de navigation
            document.getElementById('prevPage').addEventListener('click', () => navigateToPage(currentPage - 1));
            document.getElementById('nextPage').addEventListener('click', () => navigateToPage(currentPage + 1));
            document.getElementById('prevChapter').addEventListener('click', () => navigateToChapitre(currentChapitreIndex - 1));
            document.getElementById('nextChapter').addEventListener('click', () => navigateToChapitre(currentChapitreIndex + 1));

            document.getElementById('chapterSelect').addEventListener('change', function() {
                if (this.value) {
                    const index = chapitresList.indexOf(this.value);
                    if (index !== -1) {
                        navigateToChapitre(index);
                    }
                }
            });

            // √âv√©nements du modal
            document.getElementById('closeModal').addEventListener('click', closeFullscreen);
            document.getElementById('prevImageModal').addEventListener('click', () => {
                if (currentPage > 0) navigateToPage(currentPage - 1);
            });
            document.getElementById('nextImageModal').addEventListener('click', () => {
                if (currentPage < currentChapitreData.episodes.length - 1) navigateToPage(currentPage + 1);
            });

            document.getElementById('imageModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('imageModal')) {
                    closeFullscreen();
                }
            });

            // √âv√©nement formulaire commentaire
            document.getElementById('commentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const contenu = document.getElementById('commentText').value;
                commentSystem.addComment(contenu);
            });

            // Navigation clavier
            document.addEventListener('keydown', handleKeyboard);
        });

        // Gestion du changement d'URL
        window.addEventListener('popstate', initializeReader);
    </script>
</body>
</html>