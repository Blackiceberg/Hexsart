<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture - Hexart</title>
    <link rel="stylesheet" href="../assets/css/general.css">
    <style>
        .reader-container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .page-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 1rem 0;
            gap: 1rem;
        }
        
        .chapter-navigation {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .page-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            cursor: zoom-in;
            transition: transform 0.3s;
        }
        
        .page-image:hover {
            transform: scale(1.01);
        }
        
        .page-info {
            text-align: center;
            margin: 1rem 0;
            color: #666;
        }
        
        .quick-nav {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 100;
        }
        
        .quick-nav-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #3498db;
            color: white;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }
        
        .quick-nav-btn:hover {
            transform: scale(1.1);
            background: #2980b9;
        }
        
        .modal-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1rem;
        }
        
        .chapter-selector {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <header class="compact-header">
        <div class="container header-content">
            <a href="../index.html" class="logo">HEXART</a>
            <nav class="nav-links">
                <a href="../index.html">Accueil</a>
                <a href="../galerie/bd.html">BD</a>
                <a href="../admin/index.html">Admin</a>
            </nav>
        </div>
    </header>

    <main class="container reader-container">
        <!-- S√©lecteur de chapitre -->
        <div class="chapter-selector">
            <label for="chapterSelect"><strong>üìñ Navigation rapide :</strong></label>
            <select id="chapterSelect" class="form-input" style="margin-left: 1rem; width: auto;">
                <option value="">Choisir un chapitre...</option>
                <option value="chapitre-1">Chapitre 1 - Le Commencement</option>
                <option value="chapitre-2">Chapitre 2 - La For√™t Myst√©rieuse</option>
                <option value="chapitre-3">Chapitre 3 - La Rencontre</option>
                <option value="chapitre-4">Chapitre 4 - Le Temple Ancien</option>
                <option value="chapitre-5">Chapitre 5 - La Cit√© Cach√©e</option>
                <option value="chapitre-6">Chapitre 6 - L'Oc√©an des √Çmes</option>
                <option value="chapitre-7">Chapitre 7 - Le D√©sert des Illusions</option>
                <option value="chapitre-8">Chapitre 8 - La Forteresse des Ombres</option>
                <option value="chapitre-9">Chapitre 9 - Le Jardin des Dragons</option>
                <option value="chapitre-10">Chapitre 10 - Le Labyrinthe du Temps</option>
                <option value="chapitre-11">Chapitre 11 - Le Tr√¥ne de Cristal</option>
                <option value="chapitre-12">Chapitre 12 - L'Aube Nouvelle</option>
            </select>
            <a href="../galerie/bd.html" class="btn btn-secondary" style="margin-left: 1rem;">
                ‚Üê Retour aux chapitres
            </a>
        </div>

        <!-- Navigation principale -->
        <div class="reader-controls">
            <div class="chapter-navigation">
                <button id="prevChapter" class="btn btn-secondary" disabled>
                    ‚Üê Chapitre pr√©c√©dent
                </button>
                
                <div class="text-center" style="min-width: 300px;">
                    <h2 id="chapterTitle">Chargement...</h2>
                    <div id="pageCounter" class="page-info">Page 1/1</div>
                </div>
                
                <button id="nextChapter" class="btn btn-secondary">
                    Chapitre suivant ‚Üí
                </button>
            </div>
            
            <button class="btn btn-primary" onclick="openFullscreen()" title="Plein √©cran">
                ‚õ∂ Plein √©cran
            </button>
        </div>

        <!-- Image de la page -->
        <div class="text-center">
            <img id="pageImage" class="page-image" src="" alt="Page de BD" onclick="openFullscreen()">
        </div>

        <!-- Navigation pages -->
        <div class="page-controls">
            <button id="prevPage" class="btn btn-primary" disabled>‚Üê Page pr√©c√©dente</button>
            
            <div class="text-center">
                <div id="currentPage" class="stat-number">1</div>
                <div style="font-size: 0.9rem; color: #666;">Page actuelle</div>
            </div>
            
            <button id="nextPage" class="btn btn-primary">Page suivante ‚Üí</button>
        </div>

        <!-- Navigation rapide flottante -->
        <div class="quick-nav">
            <button class="quick-nav-btn" onclick="navigateToPage(0)" title="Premi√®re page">‚èÆÔ∏è</button>
            <button class="quick-nav-btn" onclick="navigateToPage(Math.max(0, currentPage - 1))" title="Page pr√©c√©dente">‚óÄÔ∏è</button>
            <button class="quick-nav-btn" onclick="navigateToPage(Math.min(currentChapitreData.episodes.length - 1, currentPage + 1))" title="Page suivante">‚ñ∂Ô∏è</button>
            <button class="quick-nav-btn" onclick="navigateToPage(currentChapitreData.episodes.length - 1)" title="Derni√®re page">‚è≠Ô∏è</button>
        </div>

        <!-- Section commentaires -->
        <section class="comments-section">
            <h3 class="text-center mb-3">üí¨ Commentaires</h3>
            
            <!-- Statut authentification -->
            <div id="authStatus" class="auth-status mb-3"></div>
            
            <!-- Formulaire de commentaire -->
            <div id="commentFormContainer" class="card p-3 mb-3">
                <h4>üìù Laisser un commentaire</h4>
                <form id="commentForm">
                    <div class="form-group">
                        <textarea 
                            id="commentText" 
                            class="form-textarea" 
                            placeholder="Partagez vos impressions sur cette page..."
                            rows="4"
                        ></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Publier le commentaire</button>
                </form>
            </div>
            
            <!-- Liste des commentaires -->
            <div id="commentsList">
                <div class="text-center p-4">
                    <p>Chargement des commentaires...</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal Plein √âcran -->
    <div class="modal" id="imageModal">
        <span class="close-btn" id="closeModal">&times;</span>
        <span class="prev-btn" id="prevImageModal">&#10094;</span>
        <span class="next-btn" id="nextImageModal">&#10095;</span>
        <img class="modal-content" id="modalImage">
        <div class="modal-controls">
            <button class="btn btn-secondary btn-small" onclick="exitFullscreen()">Quitter le plein √©cran</button>
        </div>
    </div>

    <footer style="background: #2c3e50; color: white; text-align: center; padding: 2rem; margin-top: 3rem;">
        <div class="container">
            <p>¬© 2024 Hexart - Utilisez les fl√®ches ‚Üê ‚Üí pour naviguer ‚Ä¢ ESC pour quitter le plein √©cran</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="../assets/js/comments.js"></script>
    <script>
        // Donn√©es compl√®tes des 12 chapitres
        const chapitresData = {
            "chapitre-1": {
                title: "Chapitre 1 : Le Commencement",
                description: "Fantaryou d√©couvre ses pouvoirs",
                episodes: generateEpisodes("Fantaryou-Chapitre-01", "Episode-01", 31, 0)
            },
            "chapitre-2": {
                title: "Chapitre 2 : La For√™t Myst√©rieuse",
                description: "Une exploration p√©rilleuse", 
                episodes: generateEpisodes("Fantaryou-Chapitre-01", "Episode-02", 30, 31)
            },
            "chapitre-3": {
                title: "Chapitre 3 : La Rencontre",
                description: "Une alliance inattendue",
                episodes: generateEpisodes("Fantaryou-Chapitre-01", "Episode-03", 30, 61)
            },
            "chapitre-4": {
                title: "Chapitre 4 : Le Temple Ancien",
                description: "D√©couverte des secrets ancestraux",
                episodes: generateEpisodes("Fantaryou-Chapitre-01", "Episode-04", 32, 91)
            },
            "chapitre-5": {
                title: "Chapitre 5 : La Cit√© Cach√©e",
                description: "Exploration des souterrains",
                episodes: generateEpisodes("Fantaryou-Chapitre-01", "Episode-05", 31, 123)
            },
            "chapitre-6": {
                title: "Chapitre 6 : L'Oc√©an des √Çmes",
                description: "Travers√©e des eaux mystiques",
                episodes: generateEpisodes("Fantaryou-Chapitre-01", "Episode-06", 33, 154)
            },
            "chapitre-7": {
                title: "Chapitre 7 : Le D√©sert des Illusions",
                description: "Survie dans les sables",
                episodes: generateEpisodes("Fantaryou-Chapitre-01", "Episode-07", 33, 187)
            },
            "chapitre-8": {
                title: "Chapitre 8 : La Forteresse des Ombres",
                description: "Infiltration du bastion ennemi",
                episodes: generateEpisodes("Fantaryou-Chapitre-01", "Episode-08", 31, 220)
            },
            "chapitre-9": {
                title: "Chapitre 9 : Le Jardin des Dragons",
                description: "Rencontre avec les gardiens",
                episodes: generateEpisodes("Fantaryou-Chapitre-01", "Episode-09", 32, 251)
            },
            "chapitre-10": {
                title: "Chapitre 10 : Le Labyrinthe du Temps",
                description: "Course contre la montre",
                episodes: generateEpisodes("Fantaryou-Chapitre-01", "Episode-10", 32, 283)
            },
            "chapitre-11": {
                title: "Chapitre 11 : Le Tr√¥ne de Cristal",
                description: "Confrontation finale",
                episodes: generateEpisodes("Fantaryou-Chapitre-01", "Episode-11", 32, 315)
            },
            "chapitre-12": {
                title: "Chapitre 12 : L'Aube Nouvelle",
                description: "Conclusion √©pique",
                episodes: generateEpisodes("Fantaryou-Chapitre-01", "Episode-12", 32, 347)
            }
        };

        function generateEpisodes(chapitre, episode, count, start) {
            const episodes = [];
            for (let i = 0; i < count; i++) {
                episodes.push({
                    id: start + i,
                    page: i + 1,
                    url: `../assets/images/BD/${chapitre}/${episode}/${i}.jpg`
                });
            }
            return episodes;
        }

        const chapitresList = Object.keys(chapitresData);
        let currentChapitreIndex = 0;
        let currentChapitreData = null;

        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                bd: params.get('bd') || 'Fantaryou',
                chapitre: params.get('chapitre')
            };
        }

        function initializeReader() {
            const { bd, chapitre } = getUrlParams();
            
            currentBD = bd;
            currentChapitre = chapitre;

            if (!chapitre || !chapitresData[chapitre]) {
                // Rediriger vers le premier chapitre si invalide
                navigateToChapitre(0);
                return;
            }

            currentChapitreIndex = chapitresList.indexOf(chapitre);
            currentChapitreData = chapitresData[chapitre];
            currentPage = 0;

            updateDisplay();
            updateChapterSelector();
            
            // Charger les commentaires
            commentSystem.loadComments(currentBD, currentChapitre);
        }

        function updateDisplay() {
            if (!currentChapitreData) return;

            document.getElementById('chapterTitle').textContent = currentChapitreData.title;
            document.getElementById('pageCounter').textContent = `Page ${currentPage + 1}/${currentChapitreData.episodes.length}`;
            document.getElementById('currentPage').textContent = currentPage + 1;
            
            // Mettre √† jour l'image
            const pageImage = document.getElementById('pageImage');
            if (currentChapitreData.episodes[currentPage]) {
                pageImage.src = currentChapitreData.episodes[currentPage].url;
                pageImage.alt = `Page ${currentPage + 1} - ${currentChapitreData.title}`;
                pageImage.style.display = 'block';
            } else {
                pageImage.style.display = 'none';
            }
            
            // Gestion des boutons
            updateNavigationButtons();
        }

        function updateNavigationButtons() {
            document.getElementById('prevPage').disabled = currentPage === 0;
            document.getElementById('nextPage').disabled = currentPage === currentChapitreData.episodes.length - 1;
            document.getElementById('prevChapter').disabled = currentChapitreIndex === 0;
            document.getElementById('nextChapter').disabled = currentChapitreIndex === chapitresList.length - 1;
        }

        function updateChapterSelector() {
            const selector = document.getElementById('chapterSelect');
            selector.value = currentChapitre;
        }

        function navigateToPage(page) {
            if (currentChapitreData && page >= 0 && page < currentChapitreData.episodes.length) {
                currentPage = page;
                updateDisplay();
            }
        }

        function navigateToChapitre(index) {
            if (index >= 0 && index < chapitresList.length) {
                currentChapitreIndex = index;
                currentChapitre = chapitresList[index];
                currentChapitreData = chapitresData[currentChapitre];
                currentPage = 0;
                
                // Mettre √† jour l'URL
                const newUrl = `${window.location.pathname}?bd=${currentBD}&chapitre=${currentChapitre}`;
                window.history.pushState({}, '', newUrl);
                
                updateDisplay();
                updateChapterSelector();
                
                // Recharger les commentaires
                commentSystem.loadComments(currentBD, currentChapitre);
            }
        }

        // √âv√©nements
        document.getElementById('prevPage').addEventListener('click', () => navigateToPage(currentPage - 1));
        document.getElementById('nextPage').addEventListener('click', () => navigateToPage(currentPage + 1));
        document.getElementById('prevChapter').addEventListener('click', () => navigateToChapitre(currentChapitreIndex - 1));
        document.getElementById('nextChapter').addEventListener('click', () => navigateToChapitre(currentChapitreIndex + 1));

        document.getElementById('chapterSelect').addEventListener('change', function() {
            if (this.value) {
                const index = chapitresList.indexOf(this.value);
                if (index !== -1) {
                    navigateToChapitre(index);
                }
            }
        });

        // Navigation clavier
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('imageModal').style.display === 'flex') {
                // Navigation dans le modal
                switch(e.key) {
                    case 'ArrowLeft': 
                        if (currentPage > 0) navigateToPage(currentPage - 1); 
                        break;
                    case 'ArrowRight': 
                        if (currentPage < currentChapitreData.episodes.length - 1) navigateToPage(currentPage + 1); 
                        break;
                }
            } else {
                // Navigation normale
                switch(e.key) {
                    case 'ArrowLeft':
                        if (currentPage > 0) navigateToPage(currentPage - 1);
                        else if (currentChapitreIndex > 0) navigateToChapitre(currentChapitreIndex - 1);
                        break;
                    case 'ArrowRight':
                        if (currentPage < currentChapitreData.episodes.length - 1) navigateToPage(currentPage + 1);
                        else if (currentChapitreIndex < chapitresList.length - 1) navigateToChapitre(currentChapitreIndex + 1);
                        break;
                    case 'Home': navigateToPage(0); break;
                    case 'End': navigateToPage(currentChapitreData.episodes.length - 1); break;
                    case ' ': 
                        e.preventDefault();
                        if (currentPage < currentChapitreData.episodes.length - 1) navigateToPage(currentPage + 1);
                        break;
                }
            }
        });

        // Gestion du modal
        function openFullscreen() {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            
            if (currentChapitreData && currentChapitreData.episodes[currentPage]) {
                modalImage.src = currentChapitreData.episodes[currentPage].url;
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }

        function closeFullscreen() {
            document.getElementById('imageModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function exitFullscreen() { closeFullscreen(); }

        document.getElementById('closeModal').addEventListener('click', closeFullscreen);
        document.getElementById('prevImageModal').addEventListener('click', () => {
            if (currentPage > 0) {
                navigateToPage(currentPage - 1);
                updateModalImage();
            }
        });
        document.getElementById('nextImageModal').addEventListener('click', () => {
            if (currentPage < currentChapitreData.episodes.length - 1) {
                navigateToPage(currentPage + 1);
                updateModalImage();
            }
        });

        function updateModalImage() {
            const modalImage = document.getElementById('modalImage');
            if (currentChapitreData && currentChapitreData.episodes[currentPage]) {
                modalImage.src = currentChapitreData.episodes[currentPage].url;
            }
        }

        document.getElementById('imageModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('imageModal')) {
                closeFullscreen();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('imageModal').style.display === 'flex') {
                closeFullscreen();
            }
        });

        // Initialisation
        document.addEventListener('DOMContentLoaded', initializeReader);
    </script>
</body>
</html>